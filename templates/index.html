<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>American Equity AI Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { font-family:'Montserrat',Arial,sans-serif; background:linear-gradient(120deg,#eaf1fb 30%,#dbeafe 100%);}
        .navbar { background:#07438f; }
        .logo-bg {background:white;border-radius:10px;padding:2px 14px 2px 2px;margin-right:14px;}
        .logo {max-width:95px;}
        .main-title {font-size:2em;font-weight:900;color:#07438f;text-align:center;margin-bottom:10px;}
        .subtitle {font-size:1.09em;color:#5c6c90;text-align:center;margin-bottom:10px;}
        .chat-panel-wrap {
            background: linear-gradient(120deg, #e3ebfd 60%, #f7faff 100%);
            border-radius: 22px;
            box-shadow: 0 8px 36px 0 rgba(50,74,148,0.08), 0 3px 8px 0 rgba(54,90,200,0.08);
            padding: 2.2rem 2rem 1.6rem 2rem;
            max-width: 970px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (max-width: 1200px) {
            .chat-panel-wrap { max-width: 99vw; }
        }
        @media (max-width: 900px) {
            .chat-panel-wrap { padding: 1.1rem 0.2rem 1.1rem 0.2rem; }
        }
        .chat-header {font-size:1.18em;font-weight:700;margin-bottom:14px;letter-spacing:.2px;}
        .quick-prompts {gap:0.45rem;overflow-x:auto;padding-bottom:0.5rem;margin-bottom:0.1rem;}
        .quick-prompts .btn {min-width:172px;}
        .chat-history-wrap { background: #f8faff; border-radius: 14px; min-height: 230px; max-height: 350px; overflow-y: auto; padding: 1.2em 1.6em 0.65em 1.6em; margin-bottom: 1rem; margin-top: .3em;}
        .chat-block{display:flex;flex-direction:column;}
        .chat-row {display: flex; align-items: flex-end; margin-bottom: 13px;}
        .chat-row.user {flex-direction: row-reverse;}
        .avatar-chat { width: 42px; height:42px; border-radius: 50%; background: #b4cffe; display: flex; align-items: center; justify-content: center; font-size:1.8em; box-shadow:0 0 0 1.5px #e1ebff; margin: 0 12px 0 0;}
        .chat-row.user .avatar-chat {margin: 0 0 0 14px;background:#dfedfc;}
        .chat-row.bot .avatar-chat {background:#fff;}
        .chat-bubble {
            display: inline-block;
            border-radius: 16px;
            max-width: 84vw;
            max-width: 690px;
            padding: .72em 1.2em;
            font-size: 1.11em;
            box-shadow: 0 1px 7px 0 rgba(110,130,185,0.04);
            margin-bottom: 0;
            white-space: normal;
        }
        .chat-bubble ul, .chat-bubble ol {margin-bottom: 0;}
        .bubble-bot {background:#eef3fc;color:#294167;align-self:flex-start;}
        .bubble-user {background:#dbeafe;color:#07438f;align-self:flex-end;}
        .input-group{gap:0.7rem;}
        .form-control {font-size:1.12em; padding:12px 14px;}
        .btn-primary { background-color: #07438f; border:none;}
        .btn-secondary{background-color:#a5b8d1;border:none;}
        .custom-autocomplete-list { position: absolute;z-index:1300;left:0;right:0;top:45px; background:#fff;border:1px solid #ccc;border-radius:13px;box-shadow:0 1px 8px rgba(44,56,80,0.09);min-width:200px;}
        .custom-autocomplete-item {padding:9px 18px;cursor:pointer;color:#232738;}
        .custom-autocomplete-item:hover, .custom-autocomplete-item.active {background:#f1f8fe;color:#07438f;}
        /* Dark mode styles */
        body.dark-mode {background:#181c25 !important;color:#eaf1fb;}
        body.dark-mode .navbar{background:#232738;}
        body.dark-mode .chat-panel-wrap{background:linear-gradient(120deg,#23293c 60%,#283144 100%);}
        body.dark-mode .main-title{color:#dde6fb;}
        body.dark-mode .subtitle{color:#95a3c8;}
        body.dark-mode .chat-header{color:#bbe7ff;}
        body.dark-mode .chat-history-wrap{background:#1b2232;color:#edf3fd;}
        body.dark-mode .chat-bubble {background:#304269;color:#dcebfd;}
        body.dark-mode .bubble-user{background:#07438f;color:#eaf1fb;}
        body.dark-mode .bubble-bot{background:#222c3b;color:#8dc3e3;}
        body.dark-mode .form-control{background:#232738;color:#eaf1fb;border:1px solid #303446;}
        body.dark-mode .btn-primary,body.dark-mode .btn-outline-primary{background:#07438f;color:#fff;}
        body.dark-mode .btn-secondary{background:#37415a;color:#eaf1fb;}
        body.dark-mode .custom-autocomplete-list{background:#232738;color:#eaf1fb;border:1px solid #303446;}
        body.dark-mode .custom-autocomplete-item{color:#eaf1fb;}
        body.dark-mode .custom-autocomplete-item:hover,body.dark-mode .custom-autocomplete-item.active{background:#2a3249;color:#fff;}
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder { color: #bfcde4 !important; opacity: 1;}
        body.dark-mode .text-muted { color: #bfcde4 !important;}
    </style>
</head>
<body>
<nav class="navbar d-flex justify-content-between align-items-center px-4 mb-4">
    <div class="d-flex align-items-center">
        <div class="logo-bg">
            <img src="/static/image.png" alt="American Equity Logo" class="logo rounded">
        </div>
    </div>
    <button class="btn btn-outline-light ms-auto" id="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <i class="bi bi-moon-fill"></i>
    </button>
</nav>

<div class="container" style="min-height:75vh;">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <div class="main-title mb-1">American Equity AI Sales Hub</div>
            <div class="subtitle mb-4">Ask account, pipeline, or sales questions | Get instant answers.</div>
            <div class="chat-panel-wrap">
                <div class="chat-header mb-1"><i class="bi bi-chat-left-dots"></i> Assistant Chatbot</div>
                <div class="d-flex quick-prompts mb-2 flex-wrap" aria-label="Quick prompts">
                    <button type="button" class="btn btn-outline-primary mb-2" onclick="fillChatInput('Show Open Opportunities')">Show Open Opportunities</button>
                    <button type="button" class="btn btn-outline-primary mb-2" onclick="fillChatInput('List accounts & industries')">List accounts & industries</button>
                    <button type="button" class="btn btn-outline-primary mb-2" onclick="fillChatInput('Show Closed Deals')"> Show Closed Deals</button>
		    <button type="button" class="btn btn-outline-primary mb-2" onclick="fillChatInput('Show best deal (value & sales agent)')">Show best deal (value & sales agent)</button>
                </div>
                <div id="chat-history-wrap" class="chat-history-wrap mb-2">
                    <div id="chat-block" class="chat-block">
                        {% for entry in history %}
                            {% if entry.role == "user" %}
                            <div class="chat-row user">
                                <div class="avatar-chat"><i class="bi bi-person-fill"></i></div>
                                <div class="chat-bubble bubble-user">{{ entry.html|safe }}</div>
                            </div>
                            {% elif entry.role == "assistant" %}
                            <div class="chat-row bot">
                                <div class="avatar-chat" style="background:#fff;">
                                    <img src="/static/AE.png" alt="American Equity Bot" style="width:36px;height:36px;object-fit:contain;border-radius:50%;">
                                </div>
                                <div class="chat-bubble bubble-bot">{{ entry.html|safe }}</div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div id="bot-typing" style="display:none;" class="mt-2 text-muted">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2">Bot is thinking...</span>
                    </div>
                </div>
                <form id="chat-form" class="d-flex input-group mb-0" autocomplete="off" style="position:relative;">
                    <div style="flex:1; position:relative;">
                        <input type="text" class="form-control" name="query" id="chat-input" autocomplete="off"
                            placeholder="Ask your question here..." required
                            oninput="showSuggestions(this.value)" onfocus="showSuggestions(this.value)" onblur="setTimeout(hideSuggestions, 200);">
                        <div id="autocomplete-list" class="custom-autocomplete-list" style="display:none;"></div>
                    </div>
                    <button class="btn btn-primary px-4" type="submit" aria-label="Ask"><i class="bi bi-send"></i></button>
                    <button class="btn btn-secondary px-4" type="button" onclick="clearChat();showToast('Chat cleared!')" aria-label="Reset chat"><i class="bi bi-x"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
const SUGGESTIONS = [
    "Show Open Opportunities",
    "What are you capable of?",
    "List accounts & industries",
    "Show Closed Deals",
    "Show best deal (value & sales agent)",
    "Answer me directly, which company is the runner up for total closed value?"
];

document.getElementById("chat-form").onsubmit = async function(e) {
    e.preventDefault();
    const input = document.getElementById("chat-input");
    const message = input.value.trim();
    if (!message) return;
    input.value = "";
    document.getElementById("bot-typing").style.display = "block";
    appendChatBubble("user", message);

    const response = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message})
    });
    const data = await response.json();
    appendChatBubble("assistant", data.html);
    document.getElementById("bot-typing").style.display = "none";
    let chatBlock = document.getElementById("chat-block");
    chatBlock.scrollTop = chatBlock.scrollHeight;
};

function appendChatBubble(role, html) {
    let chatBlock = document.getElementById("chat-block");
    if (role === "user") {
        chatBlock.insertAdjacentHTML('beforeend', `
            <div class="chat-row user">
                <div class="avatar-chat"><i class="bi bi-person-fill"></i></div>
                <div class="chat-bubble bubble-user">${html}</div>
            </div>`);
    } else {
        chatBlock.insertAdjacentHTML('beforeend', `
            <div class="chat-row bot">
                <div class="avatar-chat" style="background:#fff;">
                    <img src="/static/AE.png" alt="American Equity Bot" style="width:36px;height:36px;object-fit:contain;border-radius:50%;">
                </div>
                <div class="chat-bubble bubble-bot">${html}</div>
            </div>`);
    }
}

// Keep the rest of your prompt/theme/suggestion functions unchanged...
function clearChat() {
    fetch("/clear", {method:"POST"});
    document.getElementById("chat-block").innerHTML = "";
}
function fillChatInput(text) {
    document.getElementById('chat-input').value = text;
    document.getElementById('autocomplete-list').style.display = 'none';
}
function showSuggestions(query) {
    const list = document.getElementById('autocomplete-list');
    if (!query && !list.hasAttribute('data-force')) { list.style.display = 'none'; return; }
    let out = '<div class="custom-autocomplete-header">Saved info</div>';
    let matches = SUGGESTIONS.filter(s => s.toLowerCase().includes(query.toLowerCase()));
    if (matches.length === 0) { list.style.display = 'none'; return; }
    out += matches.map(s => `<div class="custom-autocomplete-item" onclick="selectSuggestion(this.innerText)">${s}</div>`).join('');
    list.innerHTML = out;
    list.style.display = 'block';
}
function hideSuggestions() {
    document.getElementById('autocomplete-list').style.display = 'none';
}
function selectSuggestion(val) {
    document.getElementById('chat-input').value = val;
    hideSuggestions();
}
// Night mode toggle and load
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem("dark-mode", document.body.classList.contains('dark-mode'));
}
window.onload = function() {
  if(localStorage.getItem("dark-mode") === "true") {
    document.body.classList.add('dark-mode');
  }
  document.getElementById('bot-typing').style.display = 'none';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;" id="toast"></div>
</body>
</html>

